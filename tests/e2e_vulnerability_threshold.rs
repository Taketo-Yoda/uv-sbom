// End-to-end tests for vulnerability threshold feature
//
// This module tests the CLI argument validation and threshold evaluation logic
// for the --severity-threshold and --cvss-threshold options.

// ============================================================================
// CLI Argument Validation Tests
// ============================================================================
// Tests using assert_cmd to verify exit codes for argument validation

mod cli_argument_tests {
    use assert_cmd::cargo::cargo_bin_cmd;

    /// Exit code 2: Invalid severity value
    #[test]
    fn test_invalid_severity_threshold_value() {
        cargo_bin_cmd!("uv-sbom")
            .args(["--check-cve", "--severity-threshold", "invalid"])
            .assert()
            .code(2);
    }

    /// Exit code 2: Invalid severity value (none)
    #[test]
    fn test_invalid_severity_threshold_none() {
        cargo_bin_cmd!("uv-sbom")
            .args(["--check-cve", "--severity-threshold", "none"])
            .assert()
            .code(2);
    }

    /// Exit code 2: Invalid CVSS threshold (negative)
    #[test]
    fn test_invalid_cvss_threshold_negative() {
        cargo_bin_cmd!("uv-sbom")
            .args(["--check-cve", "--cvss-threshold", "-1.0"])
            .assert()
            .code(2);
    }

    /// Exit code 2: Invalid CVSS threshold (too high)
    #[test]
    fn test_invalid_cvss_threshold_too_high() {
        cargo_bin_cmd!("uv-sbom")
            .args(["--check-cve", "--cvss-threshold", "11.0"])
            .assert()
            .code(2);
    }

    /// Exit code 2: Invalid CVSS threshold (not a number)
    #[test]
    fn test_invalid_cvss_threshold_not_number() {
        cargo_bin_cmd!("uv-sbom")
            .args(["--check-cve", "--cvss-threshold", "abc"])
            .assert()
            .code(2);
    }

    /// Exit code 2: Mutual exclusion - both threshold options specified
    #[test]
    fn test_mutual_exclusion_both_thresholds() {
        cargo_bin_cmd!("uv-sbom")
            .args([
                "--check-cve",
                "--severity-threshold",
                "high",
                "--cvss-threshold",
                "7.0",
            ])
            .assert()
            .code(2);
    }

    /// Severity threshold requires --check-cve
    #[test]
    fn test_severity_threshold_requires_check_cve() {
        cargo_bin_cmd!("uv-sbom")
            .args(["--severity-threshold", "high"])
            .assert()
            .code(2);
    }

    /// CVSS threshold requires --check-cve
    #[test]
    fn test_cvss_threshold_requires_check_cve() {
        cargo_bin_cmd!("uv-sbom")
            .args(["--cvss-threshold", "7.0"])
            .assert()
            .code(2);
    }

    /// Valid severity threshold values (case insensitive) - should not fail on argument parsing
    /// Note: These tests only verify argument parsing, not actual vulnerability checking
    #[test]
    fn test_valid_severity_lowercase() {
        // This will fail because of missing project, but not due to argument parsing (exit code 3, not 2)
        cargo_bin_cmd!("uv-sbom")
            .args([
                "-p",
                "/nonexistent",
                "--check-cve",
                "--severity-threshold",
                "low",
            ])
            .assert()
            .code(3); // Application error (project not found), not argument error
    }

    #[test]
    fn test_valid_severity_uppercase() {
        cargo_bin_cmd!("uv-sbom")
            .args([
                "-p",
                "/nonexistent",
                "--check-cve",
                "--severity-threshold",
                "HIGH",
            ])
            .assert()
            .code(3); // Application error, not argument error
    }

    #[test]
    fn test_valid_severity_mixedcase() {
        cargo_bin_cmd!("uv-sbom")
            .args([
                "-p",
                "/nonexistent",
                "--check-cve",
                "--severity-threshold",
                "Medium",
            ])
            .assert()
            .code(3); // Application error, not argument error
    }

    #[test]
    fn test_valid_cvss_threshold_boundary_low() {
        cargo_bin_cmd!("uv-sbom")
            .args([
                "-p",
                "/nonexistent",
                "--check-cve",
                "--cvss-threshold",
                "0.0",
            ])
            .assert()
            .code(3); // Application error, not argument error
    }

    #[test]
    fn test_valid_cvss_threshold_boundary_high() {
        cargo_bin_cmd!("uv-sbom")
            .args([
                "-p",
                "/nonexistent",
                "--check-cve",
                "--cvss-threshold",
                "10.0",
            ])
            .assert()
            .code(3); // Application error, not argument error
    }

    #[test]
    fn test_valid_cvss_threshold_integer() {
        cargo_bin_cmd!("uv-sbom")
            .args(["-p", "/nonexistent", "--check-cve", "--cvss-threshold", "7"])
            .assert()
            .code(3); // Application error, not argument error
    }
}

// ============================================================================
// Threshold Evaluation Tests
// ============================================================================
// Tests using mock repositories to verify threshold logic

mod threshold_evaluation_tests {
    use uv_sbom::sbom_generation::domain::services::{ThresholdConfig, VulnerabilityChecker};
    use uv_sbom::sbom_generation::domain::vulnerability::{
        CvssScore, PackageVulnerabilities, Severity, Vulnerability,
    };

    // Helper functions for creating test data

    fn create_vulnerability(id: &str, cvss: Option<f32>, severity: Severity) -> Vulnerability {
        let cvss_score = cvss.map(|s| CvssScore::new(s).unwrap());
        Vulnerability::new(id.to_string(), cvss_score, severity, None, None).unwrap()
    }

    fn create_package_vulnerabilities(
        name: &str,
        version: &str,
        vulnerabilities: Vec<Vulnerability>,
    ) -> PackageVulnerabilities {
        PackageVulnerabilities::new(name.to_string(), version.to_string(), vulnerabilities)
    }

    // ========== Tests without threshold options ==========

    #[test]
    fn test_no_threshold_any_vulnerability_triggers() {
        // With ThresholdConfig::None, ANY vulnerability should trigger threshold_exceeded
        let vuln_low = create_vulnerability("CVE-2024-001", Some(2.0), Severity::Low);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln_low]);

        let result = VulnerabilityChecker::check(vec![pkg], ThresholdConfig::None);

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
        assert!(result.below_threshold.is_empty());
    }

    #[test]
    fn test_no_threshold_no_vulnerabilities() {
        // With no vulnerabilities, threshold should not be exceeded
        let result = VulnerabilityChecker::check(vec![], ThresholdConfig::None);

        assert!(!result.threshold_exceeded);
        assert!(result.above_threshold.is_empty());
        assert!(result.below_threshold.is_empty());
    }

    // ========== Tests with --severity-threshold ==========

    #[test]
    fn test_severity_threshold_high_with_critical() {
        // High+ exists (Critical) → threshold exceeded
        let vuln_critical = create_vulnerability("CVE-2024-001", Some(9.8), Severity::Critical);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln_critical]);

        let result =
            VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Severity(Severity::High));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
        assert_eq!(result.above_threshold[0].vulnerabilities().len(), 1);
    }

    #[test]
    fn test_severity_threshold_high_with_high() {
        // High+ exists (High) → threshold exceeded
        let vuln_high = create_vulnerability("CVE-2024-001", Some(7.5), Severity::High);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln_high]);

        let result =
            VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Severity(Severity::High));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
    }

    #[test]
    fn test_severity_threshold_high_with_only_low_medium() {
        // Only Low/Medium → threshold NOT exceeded
        let vuln_low = create_vulnerability("CVE-2024-001", Some(2.0), Severity::Low);
        let vuln_medium = create_vulnerability("CVE-2024-002", Some(5.0), Severity::Medium);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln_low, vuln_medium]);

        let result =
            VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Severity(Severity::High));

        assert!(!result.threshold_exceeded);
        assert!(result.above_threshold.is_empty());
        assert_eq!(result.below_threshold.len(), 1);
        assert_eq!(result.below_threshold[0].vulnerabilities().len(), 2);
    }

    #[test]
    fn test_severity_threshold_critical_only() {
        // Threshold: Critical, Vulnerabilities: High + Critical
        // Only Critical should be above threshold
        let vuln_high = create_vulnerability("CVE-2024-001", Some(8.0), Severity::High);
        let vuln_critical = create_vulnerability("CVE-2024-002", Some(9.5), Severity::Critical);
        let pkg =
            create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln_high, vuln_critical]);

        let result =
            VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Severity(Severity::Critical));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
        assert_eq!(result.above_threshold[0].vulnerabilities().len(), 1); // Only Critical
        assert_eq!(result.below_threshold.len(), 1);
        assert_eq!(result.below_threshold[0].vulnerabilities().len(), 1); // Only High
    }

    #[test]
    fn test_severity_threshold_low() {
        // Threshold: Low, any vulnerability should trigger
        let vuln_low = create_vulnerability("CVE-2024-001", Some(2.0), Severity::Low);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln_low]);

        let result =
            VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Severity(Severity::Low));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
    }

    #[test]
    fn test_severity_threshold_medium() {
        // Threshold: Medium, Medium+ should trigger
        let vuln_low = create_vulnerability("CVE-2024-001", Some(2.0), Severity::Low);
        let vuln_medium = create_vulnerability("CVE-2024-002", Some(5.0), Severity::Medium);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln_low, vuln_medium]);

        let result =
            VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Severity(Severity::Medium));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
        assert_eq!(result.above_threshold[0].vulnerabilities().len(), 1); // Only Medium
        assert_eq!(result.below_threshold.len(), 1);
        assert_eq!(result.below_threshold[0].vulnerabilities().len(), 1); // Only Low
    }

    // ========== Tests with --cvss-threshold ==========

    #[test]
    fn test_cvss_threshold_exceeded() {
        // CVSS >= 7.0 exists → threshold exceeded
        let vuln = create_vulnerability("CVE-2024-001", Some(7.5), Severity::High);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln]);

        let result = VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Cvss(7.0));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
    }

    #[test]
    fn test_cvss_threshold_not_exceeded() {
        // Only CVSS < 7.0 → threshold NOT exceeded
        let vuln = create_vulnerability("CVE-2024-001", Some(6.9), Severity::Medium);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln]);

        let result = VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Cvss(7.0));

        assert!(!result.threshold_exceeded);
        assert!(result.above_threshold.is_empty());
        assert_eq!(result.below_threshold.len(), 1);
    }

    #[test]
    fn test_cvss_threshold_boundary_equal() {
        // CVSS exactly at threshold (7.0 >= 7.0) → threshold exceeded
        let vuln = create_vulnerability("CVE-2024-001", Some(7.0), Severity::High);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln]);

        let result = VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Cvss(7.0));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
    }

    #[test]
    fn test_cvss_threshold_na_excluded() {
        // N/A CVSS excluded from evaluation
        // Vulnerability with None CVSS should NOT trigger threshold
        let vuln_with_cvss = create_vulnerability("CVE-2024-001", Some(9.0), Severity::Critical);
        let vuln_without_cvss = create_vulnerability("CVE-2024-002", None, Severity::High);
        let pkg = create_package_vulnerabilities(
            "test-pkg",
            "1.0.0",
            vec![vuln_with_cvss, vuln_without_cvss],
        );

        let result = VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Cvss(7.0));

        assert!(result.threshold_exceeded);
        // Only the one with CVSS >= 7.0 should be above threshold
        assert_eq!(result.above_threshold.len(), 1);
        assert_eq!(result.above_threshold[0].vulnerabilities().len(), 1);
        // The one without CVSS should be below threshold (N/A is treated as below)
        assert_eq!(result.below_threshold.len(), 1);
        assert_eq!(result.below_threshold[0].vulnerabilities().len(), 1);
    }

    #[test]
    fn test_cvss_threshold_only_na_vulnerabilities() {
        // If all vulnerabilities have N/A CVSS, threshold should NOT be exceeded
        let vuln1 = create_vulnerability("CVE-2024-001", None, Severity::Critical);
        let vuln2 = create_vulnerability("CVE-2024-002", None, Severity::High);
        let pkg = create_package_vulnerabilities("test-pkg", "1.0.0", vec![vuln1, vuln2]);

        let result = VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Cvss(7.0));

        assert!(!result.threshold_exceeded);
        assert!(result.above_threshold.is_empty());
        assert_eq!(result.below_threshold.len(), 1);
        assert_eq!(result.below_threshold[0].vulnerabilities().len(), 2);
    }

    #[test]
    fn test_cvss_threshold_mixed_scores() {
        // Mixed CVSS scores - some above, some below
        let vuln_high = create_vulnerability("CVE-2024-001", Some(9.5), Severity::Critical);
        let vuln_medium = create_vulnerability("CVE-2024-002", Some(5.0), Severity::Medium);
        let vuln_low = create_vulnerability("CVE-2024-003", Some(2.0), Severity::Low);
        let pkg = create_package_vulnerabilities(
            "test-pkg",
            "1.0.0",
            vec![vuln_high, vuln_medium, vuln_low],
        );

        let result = VulnerabilityChecker::check(vec![pkg], ThresholdConfig::Cvss(7.0));

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
        assert_eq!(result.above_threshold[0].vulnerabilities().len(), 1); // Only 9.5
        assert_eq!(result.below_threshold.len(), 1);
        assert_eq!(result.below_threshold[0].vulnerabilities().len(), 2); // 5.0 and 2.0
    }

    // ========== Tests for multiple packages ==========

    #[test]
    fn test_multiple_packages_mixed() {
        // Package 1: Critical vulnerability
        let vuln1 = create_vulnerability("CVE-2024-001", Some(9.8), Severity::Critical);
        let pkg1 = create_package_vulnerabilities("vulnerable-pkg", "1.0.0", vec![vuln1]);

        // Package 2: Low vulnerability
        let vuln2 = create_vulnerability("CVE-2024-002", Some(2.0), Severity::Low);
        let pkg2 = create_package_vulnerabilities("safe-pkg", "1.0.0", vec![vuln2]);

        let result = VulnerabilityChecker::check(
            vec![pkg1, pkg2],
            ThresholdConfig::Severity(Severity::High),
        );

        assert!(result.threshold_exceeded);
        assert_eq!(result.above_threshold.len(), 1);
        assert_eq!(result.above_threshold[0].package_name(), "vulnerable-pkg");
        assert_eq!(result.below_threshold.len(), 1);
        assert_eq!(result.below_threshold[0].package_name(), "safe-pkg");
    }

    #[test]
    fn test_multiple_packages_all_below() {
        // All packages have only low severity vulnerabilities
        let vuln1 = create_vulnerability("CVE-2024-001", Some(2.0), Severity::Low);
        let pkg1 = create_package_vulnerabilities("pkg1", "1.0.0", vec![vuln1]);

        let vuln2 = create_vulnerability("CVE-2024-002", Some(3.0), Severity::Low);
        let pkg2 = create_package_vulnerabilities("pkg2", "1.0.0", vec![vuln2]);

        let result = VulnerabilityChecker::check(
            vec![pkg1, pkg2],
            ThresholdConfig::Severity(Severity::High),
        );

        assert!(!result.threshold_exceeded);
        assert!(result.above_threshold.is_empty());
        assert_eq!(result.below_threshold.len(), 2);
    }
}
